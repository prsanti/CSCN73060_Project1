{% extends "base.html" %}
{% block title %}Dashboard | SolveIt{% endblock %}

{% block content %}
<div class="dashboard">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <img src="{{ url_for('static', filename='images/solveit.png') }}" class="sidebar-logo" alt="SolveIt">
    </div>

    <nav class="sidebar-nav">
      <a class="active" href="/auth/dashboard">Tickets</a>
      <a href="/createtickets">Create Ticket</a>
    </nav>

    <!-- Logout at bottom -->
    <div class="sidebar-footer">
      <button id="logoutBtn" class="btn btn-secondary btn-block" type="button">Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <!-- Top Bar -->
    <div class="topbar">
      <div class="topbar-left">
        <h1 class="page-title">Tickets</h1>
        <p class="page-subtitle">Search, filter, and manage support requests.</p>
      </div>

      <!-- Search (left) + Create (right)  -->
      <div class="topbar-right">
        <form method="GET" action="" class="search-form">
          <input
            class="input search"
            type="text"
            name="title"
            placeholder="Search title"
            value="{{ request.args.get('title','') }}"
          >
        </form>

        <a class="btn create-btn" href="/createtickets">+ Create Ticket</a>
      </div>
    </div>

    <!-- Filters 1row -->
    <form method="GET" action="" class="filters-card">
      <input type="hidden" name="title" value="{{ request.args.get('title','') }}">

      <div class="filters-row">
        <div class="filter-item">
          <label class="filter-label" for="priority">Priority</label>
          <select class="input" id="priority" name="priority">
            <option value="" {% if request.args.get('priority','') == '' %}selected{% endif %}>All Priorities</option>
            <option value="low" {% if request.args.get('priority','')|lower == 'low' %}selected{% endif %}>Low</option>
            <option value="medium" {% if request.args.get('priority','')|lower == 'medium' %}selected{% endif %}>Medium</option>
            <option value="high" {% if request.args.get('priority','')|lower == 'high' %}selected{% endif %}>High</option>
            <option value="critical" {% if request.args.get('priority','')|lower == 'critical' %}selected{% endif %}>Critical</option>
          </select>
        </div>

        <div class="filter-item">
          <label class="filter-label" for="sort_by">Sort By</label>
          <select class="input" id="sort_by" name="sort_by">
            <option value="id" {% if request.args.get('sort_by','id') == 'id' %}selected{% endif %}>ID</option>
            <option value="date" {% if request.args.get('sort_by','') == 'date' %}selected{% endif %}>Date Created</option>
            <option value="title" {% if request.args.get('sort_by','') == 'title' %}selected{% endif %}>Title</option>
            <option value="priority" {% if request.args.get('sort_by','') == 'priority' %}selected{% endif %}>Priority</option>
          </select>
        </div>

        <div class="filter-item">
          <label class="filter-label" for="order">Order</label>
          <select class="input" id="order" name="order">
            <option value="asc" {% if request.args.get('order','asc') == 'asc' %}selected{% endif %}>Ascending</option>
            <option value="desc" {% if request.args.get('order','') == 'desc' %}selected{% endif %}>Descending</option>
          </select>
        </div>

        <div class="filter-actions">
          <a class="btn btn-secondary" href="?title={{ request.args.get('title','') }}">Reset</a>
          <button class="btn" type="submit">Update List</button>
        </div>
      </div>
    </form>

    <!-- Tickets Table -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Ticket List</div>
          <div class="card-meta">Showing 1–20</div>
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th style="width:90px;">ID</th>
            <th style="width:220px;">Title</th>
            <th>Description</th>
            <th style="width:140px;">Priority</th>
            <th style="width:160px;">Technician</th>
            <th style="width:140px;">Created</th>
            <th style="width:140px;">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% if tickets %}
            {% for ticket in tickets %}
              <tr>
                <td class="link">{{ ticket.ticketID }}</td>
                <td>{{ ticket.title }}</td>

                <td>
                  {% if ticket.description %}
                    {{ ticket.description[:70] }}{% if ticket.description|length > 70 %}…{% endif %}
                  {% endif %}
                </td>

                <td>
                  {% set p = (ticket.priority or '')|lower %}
                  <span class="badge {{ 'critical' if p == 'critical' else ('high' if p == 'high' else ('medium' if p == 'medium' else 'low')) }}">
                    {{ ticket.priority }}
                  </span>
                </td>

                <td>
                  {% if ticket.isAssigned and ticket.technician %}
                    <span style="color:green; font-weight:800;">
                      {{ ticket.technician.username }} ({{ ticket.technicianID }})
                    </span>
                  {% else %}
                    <span style="color:#a40000; font-weight:800;">Unassigned</span>
                  {% endif %}
                </td>

                <td>
                  {% if ticket.created_at %}
                    {{ ticket.created_at.strftime('%Y-%m-%d') }}
                  {% endif %}
                </td>

                <td>
                  {% if role == "technician" %}
                    <button class="btn-sm" type="button">Claim</button>
                  {% else %}
                    <button class="btn-sm" type="button">View</button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" style="text-align:center; padding:26px; color:#666;">
                No tickets found matching your criteria.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>

     
      <div class="table-footer">
        <button class="btn btn-secondary" type="button">Previous</button>

        <div class="pagination">
          <button class="page-btn active" type="button">1</button>
          <button class="page-btn" type="button">2</button>
          <button class="page-btn" type="button">3</button>
          <button class="page-btn" type="button">4</button>
          <button class="page-btn" type="button">5</button>
          <span class="page-ellipsis">…</span>
          <button class="page-btn" type="button">10</button>
        </div>

        <button class="btn btn-secondary" type="button">Next</button>
      </div>
    </div>

  </main>
</div>


<script>
  document.getElementById('logoutBtn').addEventListener('click', async function() {
    try {
      const response = await fetch('/auth/logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await response.json();
      if (response.ok) window.location.href = result.redirect;
    } catch (error) {
      alert("Network error while logging out.");
    }
  });
</script>
{% endblock %}
